{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-4">
  <div>
    <p class="text-muted" style="margin:0;">Manage member payments</p>
    <h2 style="margin:0;">Subscriptions</h2>
  </div>
  <span class="pill pill-neutral">{{ members|length }} members</span>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>City</th>
        <th>Plan</th>
        <th>Status</th>
        <th>Payment Ref</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for m in members %}
      <tr>
        <td><a href="/ui/admin/chat?phone={{ m.phone | urlencode }}" class="text-main"
            style="text-decoration: underline;">{{ m.name or 'Unknown' }}</a></td>
        <td class="font-mono"><a href="/ui/admin/chat?phone={{ m.phone | urlencode }}" class="text-main"
            style="text-decoration: underline;">{{ m.phone }}</a></td>
        <td>{{ m.city or 'n/a' }}</td>
        <td>{{ m.membership_type or 'n/a' }}</td>
        <td>
          {% if m.payment_status == 'paid' %}
          <span class="pill pill-success">Paid</span>
          {% elif m.payment_status == 'pending_review' %}
          <span class="pill pill-warning">Pending</span>
          {% else %}
          <span class="pill pill-neutral">{{ m.payment_status or 'unknown' }}</span>
          {% endif %}
        </td>
        <td class="font-mono text-sm">
          {% if m.payment_ref and m.payment_ref.startswith('http') %}
          <a href="javascript:void(0)" onclick="showReceipt('{{ m.payment_ref }}')"
            class="text-blue-500 hover:underline">
            View Receipt ↗
          </a>
          {% else %}
          {{ m.payment_ref or '' }}
          {% endif %}
        </td>
        <td>
          <div class="flex gap-2">
            <button
              onclick="editMember('{{ m.phone }}', '{{ m.membership_type or '' }}', '{{ m.payment_status or '' }}')"
              class="button"
              style="padding:6px 12px; font-size:12px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db;">Edit</button>

            {% if m.payment_status != 'paid' %}
            <form method="post" action="/ui/admin/subscriptions/approve" style="margin:0;">
              <input type="hidden" name="phone" value="{{ m.phone }}">
              <button type="submit" class="button button-primary"
                style="padding:6px 12px; font-size:12px;">Approve</button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
      {% if not members %}
      <tr>
        <td colspan="7" class="text-center text-muted" style="padding: 1.5rem;">No members yet.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Modals Container (Centered via Flexbox) -->
<style>
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    padding: 24px;
    width: 90%;
    max-width: 480px;
    border-radius: 20px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: modalSlideUp 0.3s ease-out;
  }

  @keyframes modalSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #f3f4f6;
    padding-bottom: 15px;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
  }

  .close-btn {
    color: #9ca3af;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s;
  }

  .close-btn:hover {
    color: #374151;
  }

  .modal-body {
    margin-bottom: 20px;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 15px;
    border-top: 1px solid #f3f4f6;
  }

  .input-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 6px;
  }

  .form-select,
  .form-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background-color: #f9fafb;
    font-size: 0.95rem;
    color: #111827;
    transition: border-color 0.2s, background-color 0.2s;
  }

  .form-select:focus,
  .form-input:focus {
    outline: none;
    border-color: var(--accent-primary);
    background-color: white;
    box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
  }
</style>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Payment Receipt</h3>
      <span class="close-btn" onclick="closeModal('receiptModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div
        style="text-align:center; background:#f9fafb; border-radius:12px; overflow:hidden; min-height:200px; display:flex; align-items:center; justify-content:center; border: 1px dashed #d1d5db;">
        <img id="modalImg" src="" style="max-width:100%; max-height:60vh; object-fit: contain;">
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('receiptModal')" class="button"
        style="background:#f3f4f6; color:#374151;">Close</button>
      <a id="modalDownload" href="" target="_blank" class="button button-primary" style="text-decoration:none;">Open
        Original ↗</a>
    </div>
  </div>
</div>

<!-- Edit Member Modal -->
<div id="editModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Subscription</h3>
      <span class="close-btn" onclick="closeModal('editModal')">&times;</span>
    </div>
    <form method="POST" action="/ui/admin/subscriptions/update">
      <div class="modal-body">
        <input type="hidden" name="phone" id="editPhone">

        <div class="input-group">
          <label class="form-label">Subscription Plan</label>
          <select name="plan" id="editPlan" class="form-select">
            <option value="lifetime">Lifetime (₦50k)</option>
            <option value="monthly">Monthly (₦5k)</option>
            <option value="onetime">One-time (₦2k)</option>
          </select>
        </div>

        <div class="input-group">
          <label class="form-label">Payment Status</label>
          <select name="status" id="editStatus" class="form-select">
            <option value="pending_review">Pending Review</option>
            <option value="paid">Paid (Approved)</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" onclick="closeModal('editModal')" class="button"
          style="background:#f3f4f6; color:#374151;">Cancel</button>
        <button type="submit" class="button button-primary" style="padding: 10px 20px;">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
  function showReceipt(url) {
    document.getElementById('modalImg').src = url;
    document.getElementById('modalDownload').href = url;
    document.getElementById('receiptModal').style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function editMember(phone, plan, status) {
    document.getElementById('editPhone').value = phone;
    document.getElementById('editPlan').value = plan;
    document.getElementById('editStatus').value = status;
    document.getElementById('editModal').style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
    document.body.style.overflow = "auto";
  }

  window.onclick = function (event) {
    if (event.target.id.endsWith('Modal')) {
      closeModal(event.target.id);
    }
  }
</script>

{% endblock %}