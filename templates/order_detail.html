{% extends "base.html" %}

{% block content %}
<div class="dashboard-header animate-slide-up">
    <div class="flex items-center gap-4">
        <a href="/ui/admin/orders" class="btn-icon" style="background: rgba(255,255,255,0.05);">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5" />
                <path d="M12 19l-7-7 7-7" />
            </svg>
        </a>
        <div>
            <h1 class="gradient-text">Order #{{ order.slug or order._id | string | truncate(8) }}</h1>
            <p class="text-secondary text-sm">Created on {{ order.created_at | datetimeformat }}</p>
        </div>
    </div>
    <div class="header-actions">
        {% if order.status == 'NEW' %}
        <span class="pill pill-info">NEW ORDER</span>
        {% elif order.status == 'WAITING_PAYMENT' %}
        <span class="pill pill-warning">AWAITING PAYMENT</span>
        {% elif order.status == 'paid' or order.status == 'CONFIRMED' %}
        <span class="pill pill-success">PAID & CONFIRMED</span>
        {% elif order.status == 'DISPATCHED' %}
        <span class="pill pill-primary">DISPATCHED</span>
        {% elif order.status == 'DELIVERED' %}
        <span class="pill pill-neutral">DELIVERED</span>
        {% else %}
        <span class="pill pill-neutral">{{ order.status }}</span>
        {% endif %}
    </div>
</div>

<div class="grid-cols-2 animate-fade-in" style="gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- Customer Card -->
    <div class="info-card-premium">
        <div class="info-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="text-accent">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <h3>Customer Details</h3>
        </div>
        <div class="info-card-body">
            <div class="info-row">
                <span class="label">Name</span>
                <span class="value">{{ member.name or 'Unknown Member' }}</span>
            </div>
            <div class="info-row">
                <span class="label">Phone</span>
                <span class="value font-mono">{{ order.member_phone or 'N/A' }}</span>
            </div>
            <div class="info-row">
                <span class="label">City</span>
                <span class="value">{{ order.city or member.city or 'N/A' }}</span>
            </div>
            <div class="info-row">
                <span class="label">Address</span>
                <span class="value text-sm">{{ order.address or member.address or 'No address provided' }}</span>
            </div>
            <div style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem;">
                <a href="/ui/admin/chat?phone={{ order.member_phone | urlencode }}" class="btn btn-secondary btn-sm"
                    style="width: 100%; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    View Chat History
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="info-card-premium">
        <div class="info-card-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="text-accent">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <h3>Order Financials</h3>
        </div>
        <div class="info-card-body">
            <div class="info-row">
                <span class="label">Total Amount</span>
                <span class="value text-xl font-bold" style="color: var(--color-success);">₦{{
                    "{:,.0f}".format(order.total) if order.total else '0' }}</span>
            </div>
            <div class="info-row">
                <span class="label">Payment Status</span>
                {% if order.status == 'PAID' or order.status == 'paid' or order.status == 'CONFIRMED' or order.status == 'DISPATCHED' or order.status == 'DELIVERED' %}
                <span class="pill pill-success">✓ Paid via Paystack</span>
                {% else %}
                <span class="pill pill-warning">Awaiting Payment</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Items Table -->
<div class="info-card-premium animate-fade-in" style="margin-bottom: 1.5rem;">
    <div class="info-card-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
            <path d="M3 6h18"></path>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <h3>Package Contents</h3>
    </div>
    <div class="premium-table-wrapper" style="padding: 0 1.5rem 1.5rem;">
        <table class="premium-table" style="box-shadow: none; background: transparent;">
            <thead>
                <tr>
                    <th>Item SKU</th>
                    <th class="text-right">Quantity</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order['items'] %}
                <tr>
                    <td class="font-medium">{{ item.sku }}</td>
                    <td class="text-right font-mono">{{ item.qty }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="2" class="text-center py-4 text-muted">No items found in this order metadata.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Actions -->
<div class="info-card-premium animate-fade-in" style="border-top: 3px solid var(--accent-primary);">
    <div class="info-card-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
            <path d="m9 12 2 2 4-4"></path>
        </svg>
        <h3>Process Order</h3>
    </div>
    <div class="info-card-body">
        <p class="text-secondary text-sm mb-4">Updating status will automatically notify the customer via WhatsApp.</p>

        <div class="flex flex-wrap gap-3">
            <form method="POST" action="/ui/admin/orders/{{ order._id }}/status">
                <input type="hidden" name="status" value="CONFIRMED">
                <button type="submit" class="btn btn-primary">
                    Confirm Order
                </button>
            </form>

            <form method="POST" action="/ui/admin/orders/{{ order._id }}/status">
                <input type="hidden" name="status" value="DISPATCHED">
                <button type="submit" class="btn btn-warning"
                    style="background: var(--color-warning); border: none; color: black;">
                    Mark Dispatched
                </button>
            </form>

            <form method="POST" action="/ui/admin/orders/{{ order._id }}/status">
                <input type="hidden" name="status" value="DELIVERED">
                <button type="submit" class="btn btn-success"
                    style="background: var(--color-success); border: none; color: black;">
                    Mark Delivered
                </button>
            </form>

            <div style="flex: 1;"></div>

            <form method="POST" action="/ui/admin/orders/{{ order._id }}/status"
                onsubmit="return confirm('Are you sure you want to cancel this order?');">
                <input type="hidden" name="status" value="CANCELLED">
                <button type="submit" class="btn btn-danger">
                    Cancel Order
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    .info-card-premium {
        background: var(--bg-card);
        border: var(--glass-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        backdrop-filter: blur(12px);
    }

    .info-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: var(--glass-border-light);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .info-card-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-card-body {
        padding: 1.5rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        align-items: center;
    }

    .info-row .label {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .info-row .value {
        color: var(--text-primary);
        font-weight: 600;
    }

    .text-accent {
        color: var(--accent-primary);
    }
</style>
{% endblock %}