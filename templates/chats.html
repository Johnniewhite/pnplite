{% extends "base.html" %}

{% block content %}
<div class="dashboard-header animate-slide-up">
  <div>
    <h1 class="gradient-text">Messaging</h1>
    <p class="text-secondary text-sm">Broadcast to all members or manage individual conversations.</p>
  </div>
</div>

<!-- Broadcast Card -->
<div class="info-card-premium animate-fade-in"
  style="margin-bottom: 2rem; border-left: 4px solid var(--accent-primary);">
  <div class="info-card-header">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
      <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
    </svg>
    <h3>Global Broadcast</h3>
  </div>
  <div class="info-card-body">
    <form method="post" action="/ui/admin/broadcast-all" enctype="multipart/form-data">
      <div class="grid-cols-2" style="gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="form-group">
          <label class="form-label">Message Body</label>
          <textarea name="body" class="form-input" placeholder="What's the update today?" required
            style="min-height: 100px; resize: vertical;"></textarea>
        </div>
        <div class="space-y-4">
          <div class="form-group">
            <label class="form-label">Media URL (Optional)</label>
            <input type="url" name="media_url" class="form-input" placeholder="https://image-host.com/img.jpg">
          </div>
          <div class="form-group">
            <label class="form-label">Or Upload File</label>
            <label class="file-upload-label" style="padding: 0.75rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="margin-bottom: 0.25rem;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
              </svg>
              <span style="font-size: 0.8rem;">Pick image/PDF</span>
              <input type="file" name="media_file" accept="image/*,application/pdf" class="form-checkbox">
            </label>
          </div>
        </div>
      </div>
      <div class="flex justify-between items-center">
        <p class="text-xs text-muted">This message will be sent to <strong>every</strong> contact in your database.</p>
        <button type="submit" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13" />
            <polyline points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
          Send Broadcast
        </button>
      </div>
    </form>
  </div>
</div>

{% if msg %}
<div class="alert alert-info animate-slide-up" style="margin-bottom: 2rem;">
  {{ msg }}
</div>
{% endif %}

<!-- Chat List -->
<div class="table-container animate-fade-in">
  <table class="premium-table">
    <thead>
      <tr>
        <th>Contact</th>
        <th>Last Message</th>
        <th>Activity</th>
        <th class="text-right">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for c in chats %}
      <tr onclick="window.location.href='/ui/admin/chat?phone={{ c._id | urlencode }}'" class="clickable-row">
        <td>
          <div class="flex items-center gap-3">
            <div class="avatar-sm">
              {{ (c.name or c._id)[0].upper() }}
            </div>
            <div>
              <div class="font-bold">{{ c.name or 'New Customer' }}</div>
              <div class="text-xs text-muted font-mono">{{ c._id }}</div>
            </div>
          </div>
        </td>
        <td>
          <div class="flex items-center gap-2">
            {% if c.media_url %}
            <span class="pill pill-neutral" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">MEDIA</span>
            {% endif %}
            <span class="text-sm truncate" style="max-width: 300px;">{{ c.last }}</span>
          </div>
        </td>
        <td class="text-muted text-xs">
          {{ c.ts | datetimeformat }}
        </td>
        <td class="text-right">
          <button class="btn btn-secondary btn-sm">
            Open Chat
          </button>
        </td>
      </tr>
      {% endfor %}
      {% if not chats %}
      <tr>
        <td colspan="4" class="text-center py-8 text-muted">No active conversations found.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<style>
  .avatar-sm {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .info-card-premium {
    background: var(--bg-card);
    border: var(--glass-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    backdrop-filter: blur(12px);
  }

  .info-card-header {
    padding: 1rem 1.5rem;
    border-bottom: var(--glass-border-light);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .info-card-header h3 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
  }

  .info-card-body {
    padding: 1.5rem;
  }

  .text-accent {
    color: var(--accent-primary);
  }
</style>
{% endblock %}