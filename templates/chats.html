{% extends "base.html" %}

{% block content %}
<div class="animate-slide-up">
  <div class="dashboard-header">
    <div>
      <h1 class="gradient-text">Chats</h1>
      <p>Message customers directly</p>
    </div>
  </div>

  <!-- Broadcast Section -->
  <div class="card" style="border-left: 3px solid var(--brand-primary);">
    <div class="card-header" style="border: none; padding-bottom: 0;">
      <h2 class="flex items-center gap-2">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4z"/>
        </svg>
        Broadcast
      </h2>
    </div>
    <form method="post" action="/ui/admin/broadcast-all" enctype="multipart/form-data">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div class="form-group" style="margin: 0;">
          <label>Message</label>
          <textarea name="body" placeholder="Your message..." required style="min-height: 80px; resize: vertical; margin: 0;"></textarea>
        </div>
        <div>
          <div class="form-group" style="margin-bottom: 0.75rem;">
            <label>Media URL (optional)</label>
            <input type="url" name="media_url" placeholder="https://..." style="margin: 0;">
          </div>
          <div class="form-group" style="margin: 0;">
            <label>Or upload file</label>
            <input type="file" name="media_file" accept="image/*,application/pdf" style="padding: 0.375rem; margin: 0;">
          </div>
        </div>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-xs text-muted">Sends to all contacts</span>
        <button type="submit" class="btn btn-primary">Send Broadcast</button>
      </div>
    </form>
  </div>

  {% if msg %}
  <div class="card" style="background: var(--success-bg); border-color: var(--success);">
    <p class="text-sm" style="color: var(--success); margin: 0;">{{ msg }}</p>
  </div>
  {% endif %}

  <!-- Chat List -->
  <div class="card" style="padding: 0; overflow: hidden;">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Contact</th>
            <th>Last Message</th>
            <th>Time</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for c in chats %}
          <tr onclick="window.location.href='/ui/admin/chat?phone={{ c._id | urlencode }}'" style="cursor: pointer;">
            <td>
              <div class="flex items-center gap-2">
                <div class="avatar-sm">{{ (c.name or c._id)[0].upper() }}</div>
                <div>
                  <div class="font-bold text-sm">{{ c.name or 'Customer' }}</div>
                  <div class="text-xs text-muted font-mono">{{ c._id }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="flex items-center gap-2">
                {% if c.media_url %}
                <span class="pill pill-neutral">Media</span>
                {% endif %}
                <span class="text-sm" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ c.last }}</span>
              </div>
            </td>
            <td class="text-muted text-xs">{{ c.ts | datetimeformat }}</td>
            <td>
              <span class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.6875rem;">Open</span>
            </td>
          </tr>
          {% endfor %}
          {% if not chats %}
          <tr>
            <td colspan="4" class="text-muted" style="text-align: center; padding: 2rem;">No conversations yet</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .avatar-sm {
    width: 28px;
    height: 28px;
    background: var(--brand-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.6875rem;
    flex-shrink: 0;
  }

  @media (max-width: 768px) {
    form > div:first-child {
      grid-template-columns: 1fr !important;
    }
  }
</style>
{% endblock %}
