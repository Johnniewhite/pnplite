{% extends "base.html" %}

{% block content %}
<div class="animate-slide-up">
  <div class="dashboard-header">
    <div>
      <h1 class="gradient-text">Catalogue</h1>
      <p>{{ products|length }} products</p>
    </div>
    <div class="flex items-center gap-2">
      <div style="position: relative;">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
          style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); opacity: 0.5;">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        <input type="text" id="catalogueSearch" placeholder="Search..."
          style="padding-left: 2.25rem; width: 180px; margin: 0;">
      </div>
      <button class="btn btn-primary" onclick="openDrawer()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Add
      </button>
    </div>
  </div>

  {% if msg %}
  <div class="card" style="background: var(--success-bg); border-color: var(--success); margin-bottom: 1rem;">
    <p class="text-sm" style="color: var(--success); margin: 0;">{{ msg }}</p>
  </div>
  {% endif %}

  <div class="catalogue-grid-premium" id="productGrid">
    {% for p in products %}
    <div class="product-card-premium" data-search="{{ p.name }} {{ p.sku }}">
      <div class="card-image-premium" style="position: relative; {% if p.image_url %}background-image: url('{{ p.image_url }}'){% endif %}">
        {% if not p.image_url %}
        <div style="height: 100%; display: flex; align-items: center; justify-content: center; background: var(--bg-elevated);">
          <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.3;">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path d="M21 15l-5-5L5 21"/>
          </svg>
        </div>
        {% endif %}
        <div class="card-overlay-badges">
          {% if p.in_stock %}
          <span class="pill pill-success">In Stock</span>
          {% else %}
          <span class="pill pill-danger">Out</span>
          {% endif %}
        </div>
      </div>

      <div class="card-details-premium">
        <h3 class="product-name-premium">{{ p.name }}</h3>
        <span class="product-sku-pill">{{ p.sku }}</span>

        {% if p.clusters %}
        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;">
          {% for c in p.clusters %}
          <span class="pill pill-neutral" style="font-size: 0.5625rem;">{{ c.city }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="price-row-premium">
          <span class="price-premium">₦{{ p.price }}</span>
        </div>
      </div>

      <div class="card-footer-premium">
        <button class="btn btn-secondary" style="flex: 1; padding: 0.375rem;" onclick='openDrawer({{ p | tojson | forceescape | safe }})'>
          Edit
        </button>
        <form method="post" action="/ui/admin/catalogue/delete" onsubmit="return confirm('Delete?');" style="flex: 1;">
          <input type="hidden" name="sku" value="{{ p.sku }}">
          <button type="submit" class="btn btn-danger" style="width: 100%; padding: 0.375rem;">Delete</button>
        </form>
      </div>
    </div>
    {% endfor %}

    {% if not products %}
    <div class="empty-placeholder" style="grid-column: 1 / -1;">
      <p>No products yet. Click "Add" to get started.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Drawer -->
<div class="drawer-overlay" id="productDrawer">
  <div class="drawer-panel">
    <form id="productForm" method="post" action="/ui/admin/catalogue" enctype="multipart/form-data"
      style="height: 100%; display: flex; flex-direction: column;">
      <div class="drawer-header">
        <h2 id="drawerTitle" class="gradient-text" style="margin: 0;">Add Product</h2>
        <button type="button" class="modal-close" onclick="closeDrawer()">&times;</button>
      </div>

      <div class="drawer-body" style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- Basic Info -->
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-group">
            <label>Product Name</label>
            <input type="text" name="name" id="pName" placeholder="e.g. Premium Rice 50kg" required style="margin: 0;">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div class="form-group" style="margin: 0;">
              <label>SKU</label>
              <input type="text" name="sku" id="pSku" placeholder="RICE-50" required style="margin: 0;">
            </div>
            <div class="form-group" style="margin: 0;">
              <label>Price (₦)</label>
              <input type="text" name="price" id="pPrice" placeholder="0.00" required style="margin: 0;">
            </div>
          </div>
        </div>

        <!-- Stock & Image -->
        <div class="form-section">
          <h4>Stock & Media</h4>
          <div class="form-group">
            <label class="form-checkbox-label" style="padding: 0;">
              <input type="checkbox" name="in_stock" id="pStock" value="true" checked style="width: auto; margin-right: 0.5rem;">
              In Stock
            </label>
          </div>
          <div class="form-group" style="margin: 0;">
            <label>Product Image</label>
            <div class="file-upload-label" id="fileUploadLabel" style="position: relative;">
              <div id="imagePlaceholder">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin-bottom: 0.25rem;">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
                <span>Upload image</span>
              </div>
              <div id="imagePreview" style="display: none; width: 100%; height: 100px; background-size: cover; background-position: center; border-radius: var(--radius-sm);"></div>
              <input type="file" name="image_file" id="pImage" accept="image/*" style="display: none;" onchange="previewFile(event)">
            </div>
            <input type="hidden" name="image_url" id="pImageUrl">
          </div>
        </div>

        <!-- Clusters -->
        <div class="form-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h4 style="margin: 0;">Locations</h4>
            <button type="button" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.6875rem;" onclick="addClusterRow()">
              + Add
            </button>
          </div>
          <div id="clusterContainer" class="cluster-rows-container"></div>
        </div>
      </div>

      <div class="drawer-footer">
        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Product</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const drawerOverlay = document.getElementById('productDrawer');
  const drawerTitle = document.getElementById('drawerTitle');
  const pName = document.getElementById('pName');
  const pSku = document.getElementById('pSku');
  const pPrice = document.getElementById('pPrice');
  const pStock = document.getElementById('pStock');
  const pImageUrl = document.getElementById('pImageUrl');
  const imagePreview = document.getElementById('imagePreview');
  const imagePlaceholder = document.getElementById('imagePlaceholder');
  const clusterContainer = document.getElementById('clusterContainer');
  const searchInput = document.getElementById('catalogueSearch');

  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase().trim();
      document.querySelectorAll('.product-card-premium').forEach(card => {
        const data = card.dataset.search.toLowerCase();
        card.style.display = data.includes(term) ? 'flex' : 'none';
      });
    });
  }

  document.getElementById('fileUploadLabel').addEventListener('click', function(e) {
    if (e.target.tagName !== 'INPUT') {
      document.getElementById('pImage').click();
    }
  });

  function previewFile(event) {
    const preview = document.getElementById('imagePreview');
    const placeholder = document.getElementById('imagePlaceholder');
    const file = event ? event.target.files[0] : null;
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = function() {
      preview.style.backgroundImage = `url(${reader.result})`;
      preview.style.display = 'block';
      placeholder.style.display = 'none';
    }
    reader.readAsDataURL(file);
  }

  function openDrawer(productData = null) {
    let product = productData;
    if (typeof productData === 'string') {
      try { product = JSON.parse(productData); } catch(e) {}
    }

    clusterContainer.innerHTML = '';
    imagePreview.style.display = 'none';
    imagePlaceholder.style.display = 'flex';
    document.getElementById('pImage').value = '';

    if (product) {
      drawerTitle.textContent = 'Edit Product';
      pName.value = product.name || '';
      pSku.value = product.sku || '';
      pPrice.value = product.price || '';
      pStock.checked = product.in_stock !== false;
      pImageUrl.value = product.image_url || '';

      if (product.image_url) {
        imagePreview.style.backgroundImage = `url(${product.image_url})`;
        imagePreview.style.display = 'block';
        imagePlaceholder.style.display = 'none';
      }

      if (product.clusters && product.clusters.length > 0) {
        product.clusters.forEach(c => addClusterRow(c));
      } else {
        addClusterRow();
      }
    } else {
      drawerTitle.textContent = 'Add Product';
      pName.value = '';
      pSku.value = '';
      pPrice.value = '';
      pStock.checked = true;
      pImageUrl.value = '';
      addClusterRow();
    }
    drawerOverlay.classList.add('open');
  }

  function closeDrawer() {
    drawerOverlay.classList.remove('open');
  }

  drawerOverlay.addEventListener('click', (e) => {
    if (e.target === drawerOverlay) closeDrawer();
  });

  function addClusterRow(data = {}) {
    const rowId = 'row-' + Math.random().toString(36).substr(2, 9);
    const div = document.createElement('div');
    div.className = 'cluster-card';
    div.id = rowId;
    div.innerHTML = `
      <div class="cluster-card-header">
        <span class="cluster-card-title">Location</span>
        <button type="button" class="cluster-delete-btn-premium" onclick="document.getElementById('${rowId}').remove()">
          <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="cluster-card-body">
        <div>
          <label class="text-xs text-muted">City</label>
          <select name="cluster_city" required style="margin: 0.25rem 0 0 0;">
            <option value="" disabled ${!data.city ? 'selected' : ''}>Select</option>
            <option value="Port Harcourt (PH)" ${data.city === 'Port Harcourt (PH)' || data.city === 'PH' ? 'selected' : ''}>Port Harcourt</option>
            <option value="Lagos Mainland" ${data.city === 'Lagos Mainland' ? 'selected' : ''}>Lagos Mainland</option>
            <option value="Lagos Island" ${data.city === 'Lagos Island' ? 'selected' : ''}>Lagos Island</option>
            <option value="Abuja" ${data.city === 'Abuja' ? 'selected' : ''}>Abuja</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-muted">Area</label>
          <input type="text" name="cluster_area" value="${data.area || ''}" placeholder="Optional" style="margin: 0.25rem 0 0 0;">
        </div>
        <div>
          <label class="text-xs text-muted">Min Units</label>
          <input type="number" name="cluster_units" value="${data.units_per_cluster || 1}" required style="margin: 0.25rem 0 0 0;">
        </div>
        <div>
          <label class="text-xs text-muted">Max People</label>
          <input type="number" name="cluster_people" value="${data.people_per_cluster || 4}" required style="margin: 0.25rem 0 0 0;">
        </div>
      </div>
    `;
    clusterContainer.appendChild(div);
  }

  {% if edit_product %}
  window.addEventListener('DOMContentLoaded', function() {
    openDrawer({{ edit_product | tojson | forceescape | safe }});
  });
  {% endif %}
</script>
{% endblock %}
